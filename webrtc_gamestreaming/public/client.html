<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Pixulse Cloud Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Press Start 2P', cursive;
      background-color: #0f0f0f;
      background-image: url("https://www.transparenttextures.com/patterns/stardust.png");
      background-repeat: repeat;
      background-size: auto;
      color: white;
    }
    nav.navbar {
      height: 80px;
      background-color: #111;
      border: none;
      border-radius: 0;
      padding: 20px 0px 0px 880px;
      z-index: 9999;
    }

    .navbar-brand img {
      height: 50px;
      margin: -17px 0px 0px 0px;
    }

    .brandname a {
      font-size: 19px;
      letter-spacing: 2px;
      color: white !important;
    }

    .viewer-container {

      height: 100vh;
      padding-top: 70px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      position: relative;
    }

    #waiting-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 70px;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 2;
    }

    .cloud-animation svg {
      width: 200px;
      height: 120px;
      filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2));
    }

    .cloud-animation {
      animation: pulseCloud 3s ease-in-out infinite;
    }

    @keyframes pulseCloud {

      0%,
      100% {
        transform: scale(1);
        filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.2));
      }

      50% {
        transform: scale(1.05);
        filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.6));
      }
    }

    #status {
      font-size: 26px;
      color: #ccc;
      margin-top: 20px;
      font-family: 'Press Start 2P', cursive;
      letter-spacing: 1px;
    }

    .pulse-button {

      padding: 18px 40px;
      font-size: 18px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: white;
      background: black;
      border: 2px solid #ffcc00;
      cursor: pointer;
      overflow: hidden;
      transition: 0.3s;
      border-radius: 30px;
      margin: 30px 0px 0px 0px;
    }

    .pulse-button:hover {
      background-color: rgba(255, 204, 0, 0.288);
      animation: pulse-effect 1.2s infinite alternate;
    }

    @keyframes pulse-effect {
      0% {
        transform: scale(1);
        box-shadow: 0 0 6px rgba(255, 204, 0, 0.8);
      }

      100% {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(255, 204, 0, 1);
      }
    }



    #remoteVideo {
      width: 82%;
      max-height: 80vh;
      margin-top: 40px;
      background-color: black;
      display: none;


      border: 6px solid transparent;
      border-radius: 18px;
      padding: 4px;
      background-clip: padding-box;


      box-shadow:
        0 0 0 2px #0f0f0f,

        0 0 0 6px rgba(0, 255, 153, 0.25),

        0 0 20px rgba(0, 255, 153, 0.3),
        inset 0 0 10px rgba(0, 255, 153, 0.4);


      position: relative;
      z-index: 1;
    }
  </style>
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" href="#"><img src="logo.png" alt="Pixulse Logo"></a>
      </div>
      <ul class="nav navbar-nav">
        <li class="brandname"><a href="#"><b>PIXULSE CLOUD BETA</b></a></li>
      </ul>

    </div>
  </nav>

  <div class="viewer-container">
    <!-- Waiting Wrapper -->
    <div id="waiting-wrapper">
      <div class="cloud-animation">
        <svg viewBox="-5 -5 74 50">
          <defs>
            <linearGradient id="cloud-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#ff0000">
                <animate attributeName="stop-color" values="#ff0000;#00ff00;#0000ff;#ff0000" dur="6s"
                  repeatCount="indefinite" />
              </stop>
              <stop offset="100%" stop-color="#0000ff">
                <animate attributeName="stop-color" values="#0000ff;#ff0000;#00ff00;#0000ff" dur="6s"
                  repeatCount="indefinite" />
              </stop>
            </linearGradient>
          </defs>

          <!-- Dim Outline -->
          <path d="M20,30 C12,30 6,24 6,17 C6,11 11,6 17,6 C18,2 22,0 26,0
                   C30,0 34,3 35,6 C38,6 40,6 43,8 C46,8 52,10 52,17
                   C52,24 46,30 38,30 Z" stroke="#444" stroke-width="2.5" fill="none" />

          <!-- RGB Animated Outline -->
          <path d="M20,30 C12,30 6,24 6,17 C6,11 11,6 17,6 C18,2 22,0 26,0
                   C30,0 34,3 35,6 C38,6 40,6 43,8 C46,8 52,10 52,17
                   C52,24 46,30 38,30 Z" stroke="url(#cloud-gradient)" stroke-width="5" fill="none"
            stroke-linecap="round" stroke-dasharray="18 290" stroke-dashoffset="0">
            <animate attributeName="stroke-dashoffset" values="0;-123" dur="1s" repeatCount="indefinite" />
          </path>
        </svg>
      </div>

      <div id="status" style=" padding:0px 0px 0px 0px;">
        <i class="fa fa-hourglass-1" style="font-size:35px;"></i>
        Waiting for stream...
      </div>
      <button class="pulse-button" onclick="location.reload()">Reconnect Stream</button>
    </div>

    <video id="remoteVideo"  autoplay playsinline controls></video>
  </div>

  <!-- WebRTC Logic -->
  <script>
    const ws = new WebSocket(`ws://localhost:8080`);
    let peerConnection;
    let id = null;

    const videoElement = document.getElementById('remoteVideo');
    const waitingWrapper = document.getElementById('waiting-wrapper');

    ws.addEventListener('open', () => {
      ws.send(JSON.stringify({ type: 'register', role: 'viewer' }));
    });

    ws.addEventListener('message', async (event) => {
      const msg = JSON.parse(event.data);

      if (msg.type === 'registered') {
        id = msg.id;
      }

      if (msg.type === 'offer') {
        peerConnection = new RTCPeerConnection();

        peerConnection.ontrack = (event) => {
          const videoElement = document.getElementById('remoteVideo');
          const stream = event.streams[0];

          // Check if stream has video tracks
          if (stream.getVideoTracks().length === 0) {
            // No actual video, show loading screen
            document.getElementById('waiting-wrapper').style.display = 'flex';
            videoElement.style.display = 'none';
            return;
          }

          // Valid stream, hide loader and show video
          videoElement.srcObject = stream;
          document.getElementById('waiting-wrapper').style.display = 'none';
          videoElement.style.display = 'block';
        };



        peerConnection.onicecandidate = (e) => {
          if (e.candidate) {
            ws.send(JSON.stringify({
              type: 'ice-candidate',
              data: e.candidate,
              to: 'streamer',
              from: id
            }));
          }
        };

        // Handle ICE disconnection
        peerConnection.oniceconnectionstatechange = () => {
          const state = peerConnection.iceConnectionState;
          if (state === 'disconnected' || state === 'failed' || state === 'closed') {
            waitingWrapper.style.display = 'flex';
            videoElement.style.display = 'none';
          }
        };

        await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.data));
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);

        ws.send(JSON.stringify({
          type: 'answer',
          data: answer,
          to: 'streamer',
          from: id
        }));
      }

      if (msg.type === 'ice-candidate' && peerConnection) {
        await peerConnection.addIceCandidate(new RTCIceCandidate(msg.data));
      }
    });
    function resetToWaiting() {
      videoElement.style.display = 'none';
      waitingWrapper.style.display = 'flex';
      videoElement.srcObject = null;
    }

  </script>

</body>

</html>